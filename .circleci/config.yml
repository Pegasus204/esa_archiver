version: 2
workflows:
  version: 2
  test:
    jobs:
      - test-ruby24
      - test-ruby25
      - test-ruby26

_test-body: &test-body
  steps:
    - checkout
    - restore_cache:
        keys:
          - esa-archiver-{{ checksum "Gemfile.lock" }}
          - esa-archiver-
    - run:
        name: Bundle Install
        command: bundle check || bundle install
    - save_cache:
        key: esa-archiver-{{ checksum "Gemfile.lock" }}
        paths:
          - vendor/bundle
    - run:
        name: Rubocop
        command: bundle exec rubocop
    - run:
        name: Run rspec in parallel
        command: |
          bundle exec rspec --profile 10 \
                            --format progress \
                            $(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings)
    - store_test_results:
        path: test_results

jobs:
  test-ruby24:
    <<: *test-body
    docker:
      - image: circleci/ruby:2.4.5

  test-ruby25:
    <<: *test-body
    docker:
      - image: circleci/ruby:2.5.3

  test-ruby26:
    <<: *test-body
    docker:
      - image: circleci/ruby:2.6.1
